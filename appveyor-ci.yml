version: 1.0.{build}
image:
  #- Visual Studio 2017
  - Ubuntu
environment:
  matrix:
    - ARCH: amd64
  DOCKER_USER:
    secure: JapmC7j5F0mY3j/MVzU+Cw==
  DOCKER_PASS:
    secure: QGlCLNWzPD0HL8ipkohVic45/yU3bVOdjn0IiV6NnSQ=
branches:
  only:
    - develop
stack: 
  - node 9, go 1.10
install:
  - yarn install
  - npm install -g rebase-docker-image
init:
  - sh: export IMAGE=linux; env
  - cmd: SET IMAGE=windows
  - ps: >-
      if (!(Test-Path ~/.docker)) { mkdir ~/.docker };
      Set-Content -Value '{ "experimental": "enabled" }' -Path ~/.docker/config.json -Encoding Ascii
build_script:
  - sh: yarn grunt release:$IMAGE:$ARCH
  - cmd: yarn grunt release:%IMAGE%:%ARCH%
  - sh: sudo bash build/ci-linux.sh $IMAGE $ARCH $DOCKER_USER $DOCKER_PASS $APPVEYOR_PULL_REQUEST_NUMBER $APPVEYOR_REPO_BRANCH
  - cmd: powershell -Command "& .\\build\\ci-windows.ps1"